# Name of the workflow (appears in GitHub Actions UI)
name: Build Aurora API

# Define when this workflow should run
on:
  # Trigger on pushes
  push:
    # Only run when pushing to the 'main' branch
    branches: ["main"]

# Jobs section (a workflow can have multiple jobs)
jobs:
  # Define a job named 'build'
  build:
    # Use GitHub's hosted Ubuntu runner (fresh VM each run)
    runs-on: ubuntu-latest

    # Steps are executed sequentially inside the job
    steps:
      # Step 1: Checkout the repository code into the runner
      - uses: actions/checkout@v3

      # Step 2: Install the .NET SDK
      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          # Specify the version (user LTS for credibility)
          dotnet-version: "9.0.x"

      # Step 3: Restore NuGet dependencies
      - name: Restore dependencies
        run: dotnet restore

      # Step 4: Build the project in Release mode
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # Step 5: Run unit tests
      - name: tests
        run: dotnet test --no-build --verbosity normal

      # Step 6: Build Docker image for CI
      - name: Build Docker image
        run: docker build -t aurora-api:ci -f api/Aurora.Api/Dockerfile .

      # Step 7: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 8: Login to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # Step 9: Tag, and push image
      - name: Tag, and push image
        run: |
          # Tag the image for ECR
          docker tag aurora-api:ci ${{ steps.login-ecr.outputs.registry }}/cbsoliman/aurora/aurora-api:ci

          # Push the image to ECR
          docker push ${{ steps.login-ecr.outputs.registry }}/cbsoliman/aurora/aurora-api:ci

      # Step 10: Register new task definition and update service
      - name: Register new task definition and update service
        run: |
          echo '{
            "family": "aurora-api-v2",
            "networkMode": "awsvpc",
            "requiresCompatibilities": [
              "FARGATE"
            ],
            "cpu": "1024",
            "memory": "2048",
            "executionRoleArn": "arn:aws:iam::693422065083:role/ecsTaskExecutionRole",
            "containerDefinitions": [
              {
                "name": "aurora-api-v2",
                "image": "'${{ steps.login-ecr.outputs.registry }}/cbsoliman/aurora/aurora-api:ci'",
                "essential": true,
                "portMappings": [
                  {
                    "containerPort": 8080,
                    "protocol": "tcp"
                  }
                ]
              }
            ]
          }' > task-def.json

          aws ecs register-task-definition --cli-input-json file://task-def.json

          REVISION=$(aws ecs describe-task-definition --task-definition aurora-api-v2 --query 'taskDefinition.revision' --output text)

          aws ecs update-service --cluster aurora-cluster-v2 --service aurora-api-service-v2 --task-definition aurora-api-v2:$REVISION
